<?php
/**
 * @var \Magento\Framework\View\Element\Template $block
 * @var \LoyaltyEngage\LoyaltyShop\Helper\Data $helper
 */
$helper = $this->helper(\LoyaltyEngage\LoyaltyShop\Helper\Data::class);

// Get customer ID from session
$customerData = $helper->getCustomer();
$customerId = $customerData['id'] ?? null;
$customeremail = $customerData['email'] ?? null;
?>

<script>
    // Alpine.js component for LoyaltyShop functionality
    document.addEventListener('alpine:init', () => {
        Alpine.data('loyaltyShop', () => ({
            customerId: <?= json_encode($customerId) ?>,
            customerEmail: <?= json_encode($customeremail) ?>,
            messageBarVisible: false,
            messageText: '',
            messageIsSuccess: true,
            timeoutId: null,
            messageConfig: null,

            init() {
                // Set global variable for backward compatibility
                window.loyaltyShopCustomerId = this.customerId;

                // Load message configuration
                this.loadMessageConfig();

                // Initialize dynamic buttons
                this.initDynamicButtons();

                // Set up observer for dynamic content
                this.setupObserver();
            },

            // Load message configuration
            async loadMessageConfig() {
                if (this.messageConfig) {
                    return this.messageConfig;
                }

                try {
                    const response = await fetch('/loyaltyengage_loyaltyshop/config/messages');
                    this.messageConfig = await response.json();
                } catch (error) {
                    console.error('Failed to load message config:', error);
                    // Set default config
                    this.messageConfig = {
                        success: {
                            message: 'Product successfully added to cart!',
                            backgroundColor: '#28a745',
                            textColor: '#ffffff'
                        },
                        error: {
                            message: 'There was an error adding the product to cart.',
                            backgroundColor: '#ffc107',
                            textColor: '#212529'
                        }
                    };
                }

                return this.messageConfig;
            },

            // Method to refresh the cart after successful API call
            refreshCart() {
                // Try different methods to refresh the cart

                // Method 1: Trigger Hyvä-specific cart update event
                document.dispatchEvent(new CustomEvent('cart:refresh'));

                // Method 2: Reload customer sections data
                try {
                    if (typeof require === 'function') {
                        require(['Magento_Customer/js/customer-data'], function (customerData) {
                            customerData.reload(['cart'], true);
                        });
                    }
                } catch (e) {
                    console.log('RequireJS not available, using alternative refresh method');
                }

                // Method 3: Reload the page after a short delay if on cart page
                if (window.location.href.indexOf('checkout/cart') !== -1) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            },

            initDynamicButtons() {
                // For Hyvä, we need to wrap buttons in an Alpine component directly
                const buttons = document.querySelectorAll('button.le-add-to-cart-button:not([data-loyalty-init]):not([x-on\\:click])');
                buttons.forEach((btn) => {
                    // Mark as initialized
                    btn.setAttribute('data-loyalty-init', 'true');

                    // Check if the button is already in an Alpine component
                    if (btn.closest('[x-data]')) {
                        // If it's already in an Alpine component, just add the click handler
                        btn.setAttribute('x-on:click', 'handleClick($el)');
                    } else {
                        // For buttons that are not in an Alpine component, we'll wrap them directly
                        // Find the product container and get data from the hidden input
                        const container = btn.closest('.loyalty-product-container');
                        let sku = '';
                        let type = '';
                        let price = '';

                        if (container) {
                            const skuInput = container.querySelector('.product-sku');
                            if (skuInput) {
                                sku = skuInput.getAttribute('data-product-sku') || '';
                                type = skuInput.getAttribute('data-type') || '';
                                price = skuInput.getAttribute('data-price') || '';
                            }
                        }

                        // Fallback to button attributes if not found in container
                        if (!sku) {
                            sku = btn.getAttribute('data-product-sku') || '';
                        }
                        if (!type) {
                            type = btn.getAttribute('data-type') || '';
                        }
                        if (!price) {
                            price = btn.getAttribute('data-price') || '';
                        }

                        // Create a wrapper div with the Alpine component
                        const wrapper = document.createElement('div');

                        // Set Alpine data attribute with inline component
                        wrapper.setAttribute('x-data', `{ 
                            customerId: ${this.customerId ? JSON.stringify(this.customerId) : 'null'},
                            
                            async handleClick(button) {
                                // Load message config
                                const config = await this.loadMessageConfig();
                                
                                // Use the same handleClick method as the main component
                                const sku = '${sku}';
                                const type = '${type}';
                                const price = '${price}';
                                
                                if (!sku || !type) {
                                    this.showMessage('Missing SKU or type.', false, config);
                                    return false;
                                }
                                
                                if (!this.customerId) {
                                    this.showMessage('Please log in to add this product to your cart.', false, config);
                                    return false;
                                }
                                
                                if (type === 'discount_code') {
                                    const discount = parseFloat(price);
                                    if (isNaN(discount)) {
                                        this.showMessage('Invalid discount value.', false, config);
                                        return false;
                                    }
                                    
                                    const endpointUrl = \`/rest/V1/loyalty/discount/\${this.customerId}/claim-after-cart\`;
                                    
                                    fetch(endpointUrl, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ discount, sku })
                                    })
                                        .then(res => res.json())
                                        .then(data => {
                                            this.showMessage(data.message, data.success, config);
                                            
                                            // Refresh the cart after successful API call
                                            if (data.success) {
                                                // Trigger Hyvä-specific cart update event
                                                document.dispatchEvent(new CustomEvent('cart:refresh'));
                                                
                                                // Reload the page after a short delay if on cart page
                                                if (window.location.href.indexOf('checkout/cart') !== -1) {
                                                    setTimeout(() => {
                                                        window.location.reload();
                                                    }, 1000);
                                                }
                                            }
                                        })
                                        .catch(err => {
                                            this.showMessage('Discount request failed.', false, config);
                                            console.error(err);
                                        });
                                } else {
                                    const endpointUrl = \`/rest/V1/loyalty/shop/\${this.customerId}/cart/add\`;
                                    
                                    fetch(endpointUrl, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ sku })
                                    })
                                        .then(res => res.json())
                                        .then(data => {
                                            this.showMessage(data.message, data.success, config);
                                            
                                            // Refresh the cart after successful API call
                                            if (data.success) {
                                                // Trigger Hyvä-specific cart update event
                                                document.dispatchEvent(new CustomEvent('cart:refresh'));
                                                
                                                // Reload the page after a short delay if on cart page
                                                if (window.location.href.indexOf('checkout/cart') !== -1) {
                                                    setTimeout(() => {
                                                        window.location.reload();
                                                    }, 1000);
                                                }
                                            }
                                        })
                                        .catch(err => {
                                            this.showMessage('Add to cart failed.', false, config);
                                            console.error(err);
                                        });
                                }
                                
                                return false;
                            },

                            async loadMessageConfig() {
                                try {
                                    const response = await fetch('/loyaltyengage_loyaltyshop/config/messages');
                                    return await response.json();
                                } catch (error) {
                                    console.error('Failed to load message config:', error);
                                    return {
                                        success: {
                                            message: 'Product successfully added to cart!',
                                            backgroundColor: '#28a745',
                                            textColor: '#ffffff'
                                        },
                                        error: {
                                            message: 'There was an error adding the product to cart.',
                                            backgroundColor: '#ffc107',
                                            textColor: '#212529'
                                        }
                                    };
                                }
                            },
                            
                            showMessage(message, isSuccess = true, config = null) {
                                this.showMessageBar(message, isSuccess);
                                }
                        }`);

                        // Clone the button
                        const newBtn = btn.cloneNode(true);

                        // Add the click handler
                        newBtn.setAttribute('x-on:click', 'handleClick($el)');

                        // Replace the original button with the wrapped version
                        wrapper.appendChild(newBtn);
                        btn.parentNode.replaceChild(wrapper, btn);
                    }
                });
            },

            setupObserver() {
                const observer = new MutationObserver(() => {
                    this.initDynamicButtons();
                });

                observer.observe(document.body, {
                    childList: true,
                    subtree: true,
                });
            },

            async showMessageBar(message, isSuccess = true) {
                const config = await this.loadMessageConfig();
                const messageConfig = isSuccess ? config.success : config.error;
                const displayMessage = message || messageConfig.message;

                // Hide any existing message first
                this.messageBarVisible = false;
                clearTimeout(this.timeoutId);

                // Small delay to ensure previous message is hidden
                setTimeout(() => {
                    this.messageText = displayMessage;
                    this.messageIsSuccess = isSuccess;
                    this.messageBarVisible = true;

                    // Auto-hide after 4 seconds
                    this.timeoutId = setTimeout(() => {
                        this.messageBarVisible = false;
                    }, 4000);
                }, 100);
            },

            // Method to manually dismiss message
            dismissMessage() {
                this.messageBarVisible = false;
                clearTimeout(this.timeoutId);
            },

            async handleClick(button) {
                // Find the product container
                const container = button.closest('.loyalty-product-container');
                if (!container) {
                    await this.showMessageBar('Product container not found.', false);
                    return false;
                }

                // Find the SKU input
                const skuInput = container.querySelector('.product-sku');
                if (!skuInput) {
                    await this.showMessageBar('Product SKU element not found.', false);
                    return false;
                }

                // Get data from attributes
                const sku = skuInput.getAttribute('data-product-sku') || skuInput.dataset.productSku;
                const type = skuInput.getAttribute('data-type') || skuInput.dataset.type;
                const rawDiscount = skuInput.getAttribute('data-price') || skuInput.dataset.price;

                // Validate data
                if (!sku || !type) {
                    await this.showMessageBar('Missing SKU or type.', false);
                    return false;
                }

                if (!this.customerId) {
                    await this.showMessageBar('Please log in to add this product to your cart.', false);
                    return false;
                }

                if (type === 'discount_code') {
                    const discount = parseFloat(rawDiscount);
                    if (isNaN(discount)) {
                        await this.showMessageBar('Invalid discount value.', false);
                        return false;
                    }

                    const endpointUrl = `/rest/V1/loyalty/discount/${this.customerId}/claim-after-cart`;

                    fetch(endpointUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ discount, sku })
                    })
                        .then(res => res.json())
                        .then(async data => {
                            await this.showMessageBar(data.message, data.success);

                            // Refresh the cart after successful API call
                            if (data.success) {
                                this.refreshCart();
                            }
                        })
                        .catch(async err => {
                            await this.showMessageBar('Discount request failed. See console.', false);
                            console.error(err);
                        });
                } else {
                    const endpointUrl = `/rest/V1/loyalty/shop/${this.customerId}/cart/add`;

                    fetch(endpointUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sku })
                    })
                        .then(res => res.json())
                        .then(async data => {
                            await this.showMessageBar(data.message, data.success);

                            // Refresh the cart after successful API call
                            if (data.success) {
                                this.refreshCart();
                            }
                        })
                        .catch(async err => {
                            await this.showMessageBar('Add to cart failed. See console.', false);
                            console.error(err);
                        });
                }

                return false;
            }
        }));
    });
</script>

<!-- Message bar component with dynamic styling -->
<div x-data="loyaltyShop">
    <div x-show="messageBarVisible" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform -translate-y-2"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform -translate-y-2"
        class="fixed top-0 left-0 w-full py-3 px-5 text-center font-bold text-base z-50 border-b-2 cursor-pointer"
        x-text="messageText"
        x-on:click="dismissMessage()"
        :style="messageBarVisible ? `background-color: ${messageConfig ? (messageIsSuccess ? messageConfig.success.backgroundColor : messageConfig.error.backgroundColor) : (messageIsSuccess ? '#28a745' : '#ffc107')}; color: ${messageConfig ? (messageIsSuccess ? messageConfig.success.textColor : messageConfig.error.textColor) : (messageIsSuccess ? '#ffffff' : '#212529')}; border-bottom-color: ${messageConfig ? (messageIsSuccess ? messageConfig.success.backgroundColor : messageConfig.error.backgroundColor) : (messageIsSuccess ? '#218838' : '#e0a800')};` : 'display: none;'"
        title="Click to dismiss">
    </div>
</div>
